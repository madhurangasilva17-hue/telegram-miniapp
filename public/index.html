<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  body{margin:0;font-family:system-ui;background:#f3f6fb;color:#111}
  .container{max-width:520px;margin:auto;padding:16px}
  .card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:0 8px 20px rgba(0,0,0,.05)}
  h2{margin:0 0 6px}
  .muted{color:#64748b;font-size:13px}
  .balance{font-size:30px;font-weight:900;color:#1e88e5;margin-top:10px}
  .ref{font-size:13px;word-break:break-all;color:#334155;font-weight:700;margin-top:8px}
  .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{flex:1;min-width:140px;padding:12px 14px;border:none;border-radius:12px;font-weight:800;cursor:pointer}
  .primary{background:#1e88e5;color:#fff}
  .soft{background:#eaf4ff;color:#1e88e5}
</style>
</head>

<body>
<div class="container">

  <div class="card">
    <h2 id="name">Loading…</h2>
    <div class="muted" id="info">Please wait</div>
    <div class="balance"><span id="bal">0</span> LKR</div>
  </div>

  <div class="card">
    <b>Your Referral Link</b>
    <div class="ref" id="link">—</div>

    <div class="btnrow">
      <button class="primary" id="copyBtn">Copy Link</button>
      <button class="soft" id="shareBtn">Share</button>
    </div>

    <div class="muted" style="margin-top:10px">
      Anyone who starts the bot with your link becomes your referral.
    </div>
  </div>

</div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();

  // ✅ IMPORTANT: your TEST bot username (no @)
  const BOT = "testmysrilanka_bot";

  const el = (id)=>document.getElementById(id);

  function referralLink(code){
    return `https://t.me/${BOT}?start=${code}`;
  }

  async function load(){
    const user = tg.initDataUnsafe?.user;

    if(!user){
      el("name").innerText = "Open inside Telegram";
      el("info").innerText = "This page works only in Telegram Mini Apps.";
      return;
    }

    el("name").innerText = user.first_name || "User";
    el("info").innerText = user.username ? ("@" + user.username) : ("ID: " + user.id);

    // ensure user+code
    await fetch("/ensure-user",{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ id:String(user.id), name:user.first_name || "User" })
    });

    // load from DB
    const res = await fetch("/user/" + user.id);
    const data = await res.json();

    el("bal").innerText = data.balance ?? 0;

    const code = String(data.code || "").toUpperCase();
    const link = referralLink(code);
    el("link").innerText = link;

    // buttons
    el("copyBtn").onclick = async () => {
      try{
        await navigator.clipboard.writeText(link);
        tg.showAlert("Copied!");
      }catch(e){
        tg.showAlert("Copy failed");
      }
    };

    el("shareBtn").onclick = () => {
      tg.openTelegramLink?.(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent("Join via my referral link")}`);
    };
  }

  load();
</script>
</body>
</html>
